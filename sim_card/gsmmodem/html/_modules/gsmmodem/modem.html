
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gsmmodem.modem &#8212; python-gsmmodem 0.9 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">python-gsmmodem 0.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gsmmodem.modem</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot; High-level API classes for an attached GSM modem &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">weakref</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">abc</span><span class="o">,</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">.serial_comms</span> <span class="k">import</span> <span class="n">SerialComms</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="k">import</span> <span class="n">CommandError</span><span class="p">,</span> <span class="n">InvalidStateException</span><span class="p">,</span> <span class="n">CmeError</span><span class="p">,</span> <span class="n">CmsError</span><span class="p">,</span> <span class="n">InterruptedException</span><span class="p">,</span> <span class="n">TimeoutException</span><span class="p">,</span> <span class="n">PinRequiredError</span><span class="p">,</span> <span class="n">IncorrectPinError</span><span class="p">,</span> <span class="n">SmscNumberUnknownError</span>
<span class="kn">from</span> <span class="nn">.pdu</span> <span class="k">import</span> <span class="n">encodeSmsSubmitPdu</span><span class="p">,</span> <span class="n">decodeSmsPdu</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">SimpleOffsetTzInfo</span><span class="p">,</span> <span class="n">lineStartingWith</span><span class="p">,</span> <span class="n">allLinesMatchingPattern</span><span class="p">,</span> <span class="n">parseTextModeTimeStr</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">compat</span> <span class="c1"># For Python 2.6 compatibility</span>
<span class="kn">from</span> <span class="nn">gsmmodem.util</span> <span class="k">import</span> <span class="n">lineMatching</span>
<span class="kn">from</span> <span class="nn">gsmmodem.exceptions</span> <span class="k">import</span> <span class="n">EncodingError</span>
<span class="n">PYTHON_VERSION</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="n">PYTHON_VERSION</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">xrange</span> <span class="o">=</span> <span class="nb">range</span>
    <span class="n">dictValuesIter</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">values</span>
    <span class="n">dictItemsIter</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span>
<span class="k">else</span><span class="p">:</span> <span class="c1">#pragma: no cover</span>
    <span class="n">dictValuesIter</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">itervalues</span>
    <span class="n">dictItemsIter</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">iteritems</span>


<div class="viewcode-block" id="Sms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Sms">[docs]</a><span class="k">class</span> <span class="nc">Sms</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Abstract SMS message base class &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="c1"># Some constants to ease handling SMS statuses</span>
    <span class="n">STATUS_RECEIVED_UNREAD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">STATUS_RECEIVED_READ</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">STATUS_STORED_UNSENT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">STATUS_STORED_SENT</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">STATUS_ALL</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1"># ...and a handy converter for text mode statuses</span>
    <span class="n">TEXT_MODE_STATUS_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;REC UNREAD&#39;</span><span class="p">:</span> <span class="n">STATUS_RECEIVED_UNREAD</span><span class="p">,</span>
                            <span class="s1">&#39;REC READ&#39;</span><span class="p">:</span> <span class="n">STATUS_RECEIVED_READ</span><span class="p">,</span>
                            <span class="s1">&#39;STO UNSENT&#39;</span><span class="p">:</span> <span class="n">STATUS_STORED_UNSENT</span><span class="p">,</span>
                            <span class="s1">&#39;STO SENT&#39;</span><span class="p">:</span> <span class="n">STATUS_STORED_SENT</span><span class="p">,</span>
                            <span class="s1">&#39;ALL&#39;</span><span class="p">:</span> <span class="n">STATUS_ALL</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">smsc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsc</span> <span class="o">=</span> <span class="n">smsc</span></div>


<div class="viewcode-block" id="ReceivedSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.ReceivedSms">[docs]</a><span class="k">class</span> <span class="nc">ReceivedSms</span><span class="p">(</span><span class="n">Sms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An SMS message that has been received (MT) &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsmModem</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">smsc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ReceivedSms</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">smsc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">gsmModem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        
<div class="viewcode-block" id="ReceivedSms.reply"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.ReceivedSms.reply">[docs]</a>    <span class="k">def</span> <span class="nf">reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convenience method that sends a reply SMS to the sender of this message &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">sendSms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SentSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.SentSms">[docs]</a><span class="k">class</span> <span class="nc">SentSms</span><span class="p">(</span><span class="n">Sms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An SMS message that has been sent (MO) &quot;&quot;&quot;</span>
        
    <span class="n">ENROUTE</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Status indicating message is still enroute to destination</span>
    <span class="n">DELIVERED</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Status indicating message has been received by destination handset</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Status indicating message delivery has failed</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">smsc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SentSms</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">smsc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Status report for this SMS (StatusReport object)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Status of this SMS. Can be ENROUTE, DELIVERED or FAILED</span>
<span class="sd">        </span>
<span class="sd">        The actual status report object may be accessed via the &#39;report&#39; attribute</span>
<span class="sd">        if status is &#39;DELIVERED&#39; or &#39;FAILED&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SentSms</span><span class="o">.</span><span class="n">ENROUTE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SentSms</span><span class="o">.</span><span class="n">DELIVERED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">deliveryStatus</span> <span class="o">==</span> <span class="n">StatusReport</span><span class="o">.</span><span class="n">DELIVERED</span> <span class="k">else</span> <span class="n">SentSms</span><span class="o">.</span><span class="n">FAILED</span></div>


<div class="viewcode-block" id="StatusReport"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.StatusReport">[docs]</a><span class="k">class</span> <span class="nc">StatusReport</span><span class="p">(</span><span class="n">Sms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; An SMS status/delivery report</span>
<span class="sd">    </span>
<span class="sd">    Note: the &#39;status&#39; attribute of this class refers to this status report SM&#39;s status (whether</span>
<span class="sd">    it has been read, etc). To find the status of the message that caused this status report,</span>
<span class="sd">    use the &#39;deliveryStatus&#39; attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">DELIVERED</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># SMS delivery status: delivery successful</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="mi">68</span> <span class="c1"># SMS delivery status: delivery failed</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsmModem</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">timeSent</span><span class="p">,</span> <span class="n">timeFinalized</span><span class="p">,</span> <span class="n">deliveryStatus</span><span class="p">,</span> <span class="n">smsc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StatusReport</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smsc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">gsmModem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeSent</span> <span class="o">=</span> <span class="n">timeSent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeFinalized</span> <span class="o">=</span> <span class="n">timeFinalized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deliveryStatus</span> <span class="o">=</span> <span class="n">deliveryStatus</span></div>


<div class="viewcode-block" id="GsmModem"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem">[docs]</a><span class="k">class</span> <span class="nc">GsmModem</span><span class="p">(</span><span class="n">SerialComms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Main class for interacting with an attached GSM modem &quot;&quot;&quot;</span>
    
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;gsmmodem.modem.GsmModem&#39;</span><span class="p">)</span>

    <span class="c1"># Used for parsing AT command errors</span>
    <span class="n">CM_ERROR_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+(CM[ES]) ERROR: (\d+)$&#39;</span><span class="p">)</span>
    <span class="c1"># Used for parsing signal strength query responses</span>
    <span class="n">CSQ_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CSQ:\s*(\d+),&#39;</span><span class="p">)</span>
    <span class="c1"># Used for parsing caller ID announcements for incoming calls. Group 1 is the number</span>
    <span class="n">CLIP_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CLIP:\s*&quot;(\+{0,1}\d+)&quot;,(\d+).*$&#39;</span><span class="p">)</span>
    <span class="c1"># Used for parsing new SMS message indications</span>
    <span class="n">CMTI_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CMTI:\s*&quot;([^&quot;]+)&quot;,(\d+)$&#39;</span><span class="p">)</span>
    <span class="c1"># Used for parsing SMS message reads (text mode)</span>
    <span class="n">CMGR_SM_DELIVER_REGEX_TEXT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Used for parsing SMS status report message reads (text mode)</span>
    <span class="n">CMGR_SM_REPORT_REGEXT_TEXT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Used for parsing SMS message reads (PDU mode)</span>
    <span class="n">CMGR_REGEX_PDU</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Used for parsing USSD event notifications</span>
    <span class="n">CUSD_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\+CUSD:\s*(\d),&quot;(.*?)&quot;,(\d+)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="c1"># Used for parsing SMS status reports</span>
    <span class="n">CDSI_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\+CDSI:\s*&quot;([^&quot;]+)&quot;,(\d+)$&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">incomingCallCallbackFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smsReceivedCallbackFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smsStatusReportCallback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GsmModem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">notifyCallbackFunc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_handleModemNotification</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incomingCallCallback</span> <span class="o">=</span> <span class="n">incomingCallCallbackFunc</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placeholderCallback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsReceivedCallback</span> <span class="o">=</span> <span class="n">smsReceivedCallbackFunc</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placeholderCallback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsStatusReportCallback</span> <span class="o">=</span> <span class="n">smsStatusReportCallback</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placeholderCallback</span>
        <span class="c1"># Flag indicating whether caller ID for incoming call notification has been set up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callingLineIdentification</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Flag indicating whether incoming call notifications have extended information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extendedIncomingCallIndication</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Current active calls (ringing and/or answered), key is the unique call ID (not the remote number)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Dict containing sent SMS messages (for auto-tracking their delivery status)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentSms</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># threading.Event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ussdResponse</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># gsmmodem.modem.Ussd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># threading.Event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># threading.Event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dialResponse</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># gsmmodem.modem.Call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waitForAtdResponse</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Flag that controls if we should wait for an immediate response to ATD, or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_waitForCallInitUpdate</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Flag that controls if we should wait for a ATD &quot;call initiated&quot; message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdates</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># populated during connect() - contains regexes and handlers for detecting/handling call status updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mustPollCallStatus</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># whether or not the modem must be polled for outgoing call status updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pollCallStatusRegex</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Regular expression used when polling outgoing call status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Time (in seconds to wait after writing a command (adjusted when 515 errors are detected)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Storage variable for the smsTextMode property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Default SMSC number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsRef</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Sent SMS reference counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemReadDelete</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Preferred message storage memory for reads/deletes (&lt;mem1&gt; parameter used for +CPMS)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemWrite</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Preferred message storage memory for writes (&lt;mem2&gt; parameter used for +CPMS)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsReadSupported</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Whether or not reading SMS messages is supported via AT commands</span>

<div class="viewcode-block" id="GsmModem.connect"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Opens the port and initializes the modem and SIM card</span>
<span class="sd">         </span>
<span class="sd">        :param pin: The SIM card PIN code, if any</span>
<span class="sd">        :type pin: str</span>
<span class="sd">        </span>
<span class="sd">        :raise PinRequiredError: if the SIM card requires a PIN but none was provided</span>
<span class="sd">        :raise IncorrectPinError: if the specified PIN is incorrect</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Connecting to modem on port </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%d</span><span class="s1">bps&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span><span class="p">)</span>        
        <span class="nb">super</span><span class="p">(</span><span class="n">GsmModem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="c1"># Send some initialization commands to the modem</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATZ&#39;</span><span class="p">)</span> <span class="c1"># reset configuration</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="c1"># Some modems require a SIM PIN at this stage already; unlock it now</span>
            <span class="c1"># Attempt to enable detailed error messages (to catch incorrect PIN error)</span>
            <span class="c1"># but ignore if it fails</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMEE=1&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlockSim</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="n">pinCheckComplete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATZ&#39;</span><span class="p">)</span> <span class="c1"># reset configuration        </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pinCheckComplete</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATE0&#39;</span><span class="p">)</span> <span class="c1"># echo off</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cfun</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CFUN:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CFUN?&#39;</span><span class="p">))[</span><span class="mi">7</span><span class="p">:])</span> <span class="c1"># example response: +CFUN: 1</span>
            <span class="k">if</span> <span class="n">cfun</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CFUN=1&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># just ignore if the +CFUN command isn&#39;t supported</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMEE=1&#39;</span><span class="p">)</span> <span class="c1"># enable detailed error messages (even if it has already been set - ATZ may reset this)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pinCheckComplete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unlockSim</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

        <span class="c1"># Get list of supported commands from modem</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supportedCommands</span>

        <span class="c1"># Device-specific settings</span>
        <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># unknown modem</span>
        <span class="n">enableWind</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">commands</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;^CVOICE&#39;</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT^CVOICE=0&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Enable voice calls</span>
            <span class="k">if</span> <span class="s1">&#39;+VTS&#39;</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span> <span class="c1"># Check for DTMF sending support</span>
                <span class="n">Call</span><span class="o">.</span><span class="n">dtmfSupport</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="s1">&#39;^DTMF&#39;</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="c1"># Huawei modems use ^DTMF to send DTMF tones</span>
                <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Huawei</span>
            <span class="k">if</span> <span class="s1">&#39;^USSDMODE&#39;</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="c1"># Enable Huawei text-mode USSD</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT^USSDMODE=0&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;+WIND&#39;</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Wavecom</span>
                <span class="n">enableWind</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="s1">&#39;+ZPAS&#39;</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
                <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># ZTE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to enable general notifications on Wavecom-like device</span>
            <span class="n">enableWind</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">enableWind</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wind</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+WIND:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+WIND?&#39;</span><span class="p">))</span> <span class="c1"># Check current WIND value; example response: +WIND: 63</span>
            <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
                <span class="c1"># Modem does not support +WIND notifications. See if we can detect other known call update notifications</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Enable notifications for call setup, hangup, etc</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">wind</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span> <span class="o">!=</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+WIND=50&#39;</span><span class="p">)</span>
                <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Wavecom</span>

        <span class="c1"># Attempt to identify modem type directly (if not already) - for outgoing call status updates</span>
        <span class="k">if</span> <span class="n">callUpdateTableHint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manufacturer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;huawei&#39;</span><span class="p">:</span>
                <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># huawei</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># See if this is a ZTE modem that has not yet been identified based on supported commands</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+ZPAS?&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c1"># Not a ZTE modem</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">callUpdateTableHint</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># ZTE</span>
        <span class="c1"># Load outgoing call status updates based on identified modem features</span>
        <span class="k">if</span> <span class="n">callUpdateTableHint</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Use Hauwei&#39;s ^NOTIFICATIONs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading Huawei call state update table&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdates</span> <span class="o">=</span> <span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\^ORIG:(\d),(\d)$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallInitiated</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\^CONN:(\d),(\d)$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallAnswered</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\^CEND:(\d),(\d),(\d)+,(\d)+$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallEnded</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mustPollCallStatus</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Huawei modems use ^DTMF to send DTMF tones; use that instead</span>
            <span class="n">Call</span><span class="o">.</span><span class="n">DTMF_COMMAND_BASE</span> <span class="o">=</span> <span class="s1">&#39;^DTMF=</span><span class="si">{cid}</span><span class="s1">,&#39;</span>
            <span class="n">Call</span><span class="o">.</span><span class="n">dtmfSupport</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">callUpdateTableHint</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Wavecom modem: +WIND notifications supported</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading Wavecom call state update table&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdates</span> <span class="o">=</span> <span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+WIND: 5,(\d)$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallInitiated</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^OK$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallAnswered</span><span class="p">),</span>
                                      <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+WIND: 6,(\d)$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallEnded</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waitForAtdResponse</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Wavecom modems return OK only when the call is answered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mustPollCallStatus</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">commands</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># older modem, assume it has standard DTMF support</span>
                <span class="n">Call</span><span class="o">.</span><span class="n">dtmfSupport</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">callUpdateTableHint</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># ZTE</span>
            <span class="c1"># Use ZTE notifications (&quot;CONNECT&quot;/&quot;HANGUP&quot;, but no &quot;call initiated&quot; notification)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading ZTE call state update table&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdates</span> <span class="o">=</span> <span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^CONNECT$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallAnswered</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^HANGUP:\s*(\d+)$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallEnded</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^OK$&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallRejected</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waitForAtdResponse</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># ZTE modems do not return an immediate  OK only when the call is answered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mustPollCallStatus</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waitForCallInitUpdate</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># ZTE modems do not provide &quot;call initiated&quot; updates</span>
            <span class="k">if</span> <span class="n">commands</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># ZTE uses standard +VTS for DTMF</span>
                <span class="n">Call</span><span class="o">.</span><span class="n">dtmfSupport</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown modem - we do not know what its call updates look like. Use polling instead</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unknown/generic modem type - will use polling for call state updates&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mustPollCallStatus</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pollCallStatusRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^\+CLCC:\s+(\d+),(\d),(\d),(\d),([^,]),&quot;([^,]*)&quot;,(\d+)$&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_waitForAtdResponse</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Most modems return OK immediately after issuing ATD</span>

        <span class="c1"># General meta-information setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+COPS=3,0&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Use long alphanumeric name format</span>
                
        <span class="c1"># SMS setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGF=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># Switch to text or PDU mode for SMS messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compileSmsRegexes</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CSCA=&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span><span class="p">))</span> <span class="c1"># Set default SMSC number</span>
            <span class="n">currentSmscNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">currentSmscNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsc</span>
        <span class="c1"># Some modems delete the SMSC number when setting text-mode SMS parameters; preserve it if needed</span>
        <span class="k">if</span> <span class="n">currentSmscNumber</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># clear cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CSMP=49,167,0,0&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Enable delivery reports</span>
        <span class="c1"># ...check SMSC again to ensure it did not change</span>
        <span class="k">if</span> <span class="n">currentSmscNumber</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsc</span> <span class="o">!=</span> <span class="n">currentSmscNumber</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsc</span> <span class="o">=</span> <span class="n">currentSmscNumber</span>

        <span class="c1"># Set message storage, but first check what the modem supports - example response: +CPMS: ((&quot;SM&quot;,&quot;BM&quot;,&quot;SR&quot;),(&quot;SM&quot;))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cpmsLine</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CPMS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CPMS=?&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="c1"># Modem does not support AT+CPMS; SMS reading unavailable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsReadSupported</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;SMS preferred message storage query not supported by modem. SMS reading unavailable.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpmsSupport</span> <span class="o">=</span> <span class="n">cpmsLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;),(&#39;</span><span class="p">)</span>
            <span class="c1"># Do a sanity check on the memory types returned - Nokia S60 devices return empty strings, for example</span>
            <span class="k">for</span> <span class="n">memItem</span> <span class="ow">in</span> <span class="n">cpmsSupport</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memItem</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># No support for reading stored SMS via AT commands - probably a Nokia S60</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_smsReadSupported</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid SMS message storage support returned by modem. SMS reading unavailable. Response was: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">cpmsLine</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Suppported memory types look fine, continue</span>
                <span class="n">preferredMemoryTypes</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&quot;ME&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;SM&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;SR&quot;&#39;</span><span class="p">)</span>
                <span class="n">cpmsItems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cpmsSupport</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cpmsSupport</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">memType</span> <span class="ow">in</span> <span class="n">preferredMemoryTypes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">memType</span> <span class="ow">in</span> <span class="n">cpmsSupport</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemReadDelete</span> <span class="o">=</span> <span class="n">memType</span>
                            <span class="n">cpmsItems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">memType</span>
                            <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CPMS=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpmsItems</span><span class="p">)))</span> <span class="c1"># Set message storage</span>
            <span class="k">del</span> <span class="n">cpmsSupport</span>
            <span class="k">del</span> <span class="n">cpmsLine</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsReadSupported</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CNMI=2,1,0,2&#39;</span><span class="p">)</span> <span class="c1"># Set message notifications</span>
            <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
                <span class="c1"># Message notifications not supported</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smsReadSupported</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Incoming SMS notifications not supported by modem. SMS receiving unavailable.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Incoming call notification setup</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CLIP=1&#39;</span><span class="p">)</span> <span class="c1"># Enable calling line identification presentation</span>
        <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">clipError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callingLineIdentification</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Incoming call calling line identification (caller ID) not supported by modem. Error: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clipError</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callingLineIdentification</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CRC=1&#39;</span><span class="p">)</span> <span class="c1"># Enable extended format of incoming indication (optional)</span>
            <span class="k">except</span> <span class="n">CommandError</span> <span class="k">as</span> <span class="n">crcError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extendedIncomingCallIndication</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Extended format incoming call indication not supported by modem. Error: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crcError</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_extendedIncomingCallIndication</span> <span class="o">=</span> <span class="kc">True</span>        

        <span class="c1"># Call control setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CVHU=0&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Enable call hang-up with ATH command (ignore if command not supported)</span></div>
    
    <span class="k">def</span> <span class="nf">_unlockSim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Unlocks the SIM card using the specified PIN (if necessary, else does nothing) &quot;&quot;&quot;</span>
        <span class="c1"># Unlock the SIM card if needed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cpinResponse</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CPIN&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CPIN?&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.25</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="c1"># Wavecom modems do not end +CPIN responses with &quot;OK&quot; (github issue #19) - see if just the +CPIN response was returned</span>
            <span class="k">if</span> <span class="n">timeout</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cpinResponse</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CPIN&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cpinResponse</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># No useful response read</span>
                    <span class="k">raise</span> <span class="n">timeout</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Nothing read (real timeout)</span>
                <span class="k">raise</span> <span class="n">timeout</span>
        <span class="k">if</span> <span class="n">cpinResponse</span> <span class="o">!=</span> <span class="s1">&#39;+CPIN: READY&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CPIN=&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PinRequiredError</span><span class="p">(</span><span class="s1">&#39;AT+CPIN&#39;</span><span class="p">)</span>
               
<div class="viewcode-block" id="GsmModem.write"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">waitForResponse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">writeTerm</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">expectedResponseTermSeq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write data to the modem.</span>

<span class="sd">        This method adds the ``\\r\\n`` end-of-line sequence to the data parameter, and</span>
<span class="sd">        writes it to the modem.</span>

<span class="sd">        :param data: Command/data to be written to the modem</span>
<span class="sd">        :type data: str</span>
<span class="sd">        :param waitForResponse: Whether this method should block and return the response from the modem or not</span>
<span class="sd">        :type waitForResponse: bool</span>
<span class="sd">        :param timeout: Maximum amount of time in seconds to wait for a response from the modem</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :param parseError: If True, a CommandError is raised if the modem responds with an error (otherwise the response is returned as-is)</span>
<span class="sd">        :type parseError: bool</span>
<span class="sd">        :param writeTerm: The terminating sequence to append to the written data</span>
<span class="sd">        :type writeTerm: str</span>
<span class="sd">        :param expectedResponseTermSeq: The expected terminating sequence that marks the end of the modem&#39;s response (defaults to ``\\r\\n``)</span>
<span class="sd">        :type expectedResponseTermSeq: str</span>

<span class="sd">        :raise CommandError: if the command returns an error (only if parseError parameter is True)</span>
<span class="sd">        :raise TimeoutException: if no response to the command was received from the modem</span>

<span class="sd">        :return: A list containing the response lines from the modem, or None if waitForResponse is False</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;write: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">responseLines</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GsmModem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">writeTerm</span><span class="p">,</span> <span class="n">waitForResponse</span><span class="o">=</span><span class="n">waitForResponse</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">expectedResponseTermSeq</span><span class="o">=</span><span class="n">expectedResponseTermSeq</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Sleep a bit if required (some older modems suffer under load)            </span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">waitForResponse</span><span class="p">:</span>
            <span class="n">cmdStatusLine</span> <span class="o">=</span> <span class="n">responseLines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parseError</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;ERROR&#39;</span> <span class="ow">in</span> <span class="n">cmdStatusLine</span><span class="p">:</span>
                    <span class="n">cmErrorMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CM_ERROR_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">cmdStatusLine</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmErrorMatch</span><span class="p">:</span>
                        <span class="n">errorType</span> <span class="o">=</span> <span class="n">cmErrorMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">errorCode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmErrorMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">errorCode</span> <span class="o">==</span> <span class="mi">515</span> <span class="ow">or</span> <span class="n">errorCode</span> <span class="o">==</span> <span class="mi">14</span><span class="p">:</span>
                            <span class="c1"># 515 means: &quot;Please wait, init or command processing in progress.&quot;</span>
                            <span class="c1"># 14 means &quot;SIM busy&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span> <span class="o">+=</span> <span class="mf">0.2</span> <span class="c1"># Increase waiting period temporarily</span>
                            <span class="c1"># Retry the command after waiting a bit</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Device/SIM busy error detected; self._writeWait adjusted to </span><span class="si">%f</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span><span class="p">)</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span><span class="p">)</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">waitForResponse</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">parseError</span><span class="p">,</span> <span class="n">writeTerm</span><span class="p">,</span> <span class="n">expectedResponseTermSeq</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;self_writeWait set to 0.1 because of recovering from device busy (515) error&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">errorCode</span> <span class="o">==</span> <span class="mi">515</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># Set this to something sane for further commands (slow modem)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_writeWait</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># The modem was just waiting for the SIM card</span>
                            <span class="k">return</span> <span class="n">result</span>
                        <span class="k">if</span> <span class="n">errorType</span> <span class="o">==</span> <span class="s1">&#39;CME&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CmeError</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">errorCode</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># CMS error</span>
                            <span class="k">raise</span> <span class="n">CmsError</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">errorCode</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cmdStatusLine</span> <span class="o">==</span> <span class="s1">&#39;COMMAND NOT SUPPORT&#39;</span><span class="p">:</span> <span class="c1"># Some Huawei modems respond with this for unknown commands</span>
                    <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmdStatusLine</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">responseLines</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signalStrength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Checks the modem&#39;s cellular network signal strength</span>
<span class="sd">        </span>
<span class="sd">        :raise CommandError: if an error occurs</span>
<span class="sd">        </span>
<span class="sd">        :return: The network signal strength as an integer between 0 and 99, or -1 if it is unknown</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CSQ_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CSQ&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">csq</span><span class="p">:</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">csq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ss</span> <span class="k">if</span> <span class="n">ss</span> <span class="o">!=</span> <span class="mi">99</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CommandError</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">manufacturer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: The modem&#39;s manufacturer&#39;s name &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CGMI&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: The modem&#39;s model name &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CGMM&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">revision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: The modem&#39;s software revision, or None if not known/supported &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CGMR&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imei</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: The modem&#39;s serial number (IMEI number) &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CGSN&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imsi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: The IMSI (International Mobile Subscriber Identity) of the SIM card. The PIN may need to be entered before reading the IMSI &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CIMI&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">networkName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: the name of the GSM Network Operator to which the modem is connected &quot;&quot;&quot;</span>
        <span class="n">copsMatch</span> <span class="o">=</span> <span class="n">lineMatching</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+COPS: (\d),(\d),&quot;(.+)&quot;,{0,1}\d*$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+COPS?&#39;</span><span class="p">))</span> <span class="c1"># response format: +COPS: mode,format,&quot;operator_name&quot;,x</span>
        <span class="k">if</span> <span class="n">copsMatch</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copsMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supportedCommands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: list of AT commands supported by this modem (without the AT prefix). Returns None if not known &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># AT+CLAC responses differ between modems. Most respond with +CLAC: and then a comma-separated list of commands</span>
            <span class="c1"># while others simply return each command on a new line, with no +CLAC: prefix</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CLAC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Single-line response, comma separated</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">commands</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CLAC&#39;</span><span class="p">):</span>
                    <span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="c1"># remove the +CLAC: prefix before splitting</span>
                <span class="k">return</span> <span class="n">commands</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Multi-line response</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Unhandled +CLAC response: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">smsTextMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: True if the modem is set to use text mode for SMS, False if it is set to use PDU mode &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span>
    <span class="nd">@smsTextMode</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">smsTextMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">textMode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set to True for the modem to use text mode for SMS, or False for it to use PDU mode &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">textMode</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGF=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">textMode</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span> <span class="o">=</span> <span class="n">textMode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compileSmsRegexes</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_setSmsMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readDelete</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the current SMS memory to use for read/delete/write operations &quot;&quot;&quot;</span>
        <span class="c1"># Switch to the correct memory type if required</span>
        <span class="k">if</span> <span class="n">write</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">write</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemWrite</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
            <span class="n">readDel</span> <span class="o">=</span> <span class="n">readDelete</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemReadDelete</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CPMS=&quot;</span><span class="si">{0}</span><span class="s1">&quot;,&quot;</span><span class="si">{1}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">readDel</span><span class="p">,</span> <span class="n">write</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemReadDelete</span> <span class="o">=</span> <span class="n">readDel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemWrite</span> <span class="o">=</span> <span class="n">write</span>
        <span class="k">elif</span> <span class="n">readDelete</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">readDelete</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemReadDelete</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CPMS=&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">readDelete</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsMemReadDelete</span> <span class="o">=</span> <span class="n">readDelete</span>

    <span class="k">def</span> <span class="nf">_compileSmsRegexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compiles regular expression used for parsing SMS messages based on current mode &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_SM_DELIVER_REGEX_TEXT</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_SM_DELIVER_REGEX_TEXT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CMGR: &quot;([^&quot;]+)&quot;,&quot;([^&quot;]+)&quot;,[^,]*,&quot;([^&quot;]+)&quot;$&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_SM_REPORT_REGEXT_TEXT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CMGR: ([^,]*),\d+,(\d+),&quot;{0,1}([^&quot;]*)&quot;{0,1},\d*,&quot;([^&quot;]+)&quot;,&quot;([^&quot;]+)&quot;,(\d+)$&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_REGEX_PDU</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_REGEX_PDU</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CMGR: (\d*),&quot;{0,1}([^&quot;]*)&quot;{0,1},(\d+)$&#39;</span><span class="p">)</span>
            
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">smsc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :return: The default SMSC number stored on the SIM card &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">readSmsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CSCA?&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">SmscNumberUnknownError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># Some modems return a CMS 330 error if the value isn&#39;t set</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cscaMatch</span> <span class="o">=</span> <span class="n">lineMatching</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\+CSCA:\s*&quot;([^,]+)&quot;,(\d+)$&#39;</span><span class="p">,</span> <span class="n">readSmsc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cscaMatch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span> <span class="o">=</span> <span class="n">cscaMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span>
    <span class="nd">@smsc</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">smsc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smscNumber</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the default SMSC number to use when sending SMS messages &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">smscNumber</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CSCA=&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smscNumber</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smscNumber</span> <span class="o">=</span> <span class="n">smscNumber</span>

<div class="viewcode-block" id="GsmModem.waitForNetworkCoverage"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.waitForNetworkCoverage">[docs]</a>    <span class="k">def</span> <span class="nf">waitForNetworkCoverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Block until the modem has GSM network coverage.</span>
<span class="sd">        </span>
<span class="sd">        This method blocks until the modem is registered with the network </span>
<span class="sd">        and the signal strength is greater than 0, optionally timing out</span>
<span class="sd">        if a timeout was specified</span>
<span class="sd">        </span>
<span class="sd">        :param timeout: Maximum time to wait for network coverage, in seconds</span>
<span class="sd">        :type timeout: int or float</span>

<span class="sd">        :raise TimeoutException: if a timeout was specified and reached</span>
<span class="sd">        :raise InvalidStateException: if the modem is not going to receive network coverage (SIM blocked, etc)</span>

<span class="sd">        :return: the current signal strength</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set up a timeout mechanism</span>
            <span class="k">def</span> <span class="nf">_cancelBlock</span><span class="p">():</span>                
                <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>                
            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">_cancelBlock</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">checkCreg</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">checkCreg</span><span class="p">:</span>
                <span class="n">cregResult</span> <span class="o">=</span> <span class="n">lineMatching</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CREG:\s*(\d),(\d)$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CREG?&#39;</span><span class="p">,</span> <span class="n">parseError</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="c1"># example result: +CREG: 0,1</span>
                <span class="k">if</span> <span class="n">cregResult</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cregResult</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="c1"># 1: registered, home network, 5: registered, roaming</span>
                        <span class="c1"># Now simply check and return network signal strength</span>
                        <span class="n">checkCreg</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span><span class="s1">&#39;Network registration denied&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span><span class="s1">&#39;Device not searching for network operator&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Disable network registration check; only use signal strength</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;+CREG check disabled due to invalid response or unsupported command&#39;</span><span class="p">)</span>
                    <span class="n">checkCreg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check signal strength</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalStrength</span>
                <span class="k">if</span> <span class="n">ss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ss</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If this is reached, the timer task has triggered</span>
            <span class="k">raise</span> <span class="n">TimeoutException</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="GsmModem.sendSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.sendSms">[docs]</a>    <span class="k">def</span> <span class="nf">sendSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">waitForDeliveryReport</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deliveryTimeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">sendFlash</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send an SMS text message</span>
<span class="sd">        </span>
<span class="sd">        :param destination: the recipient&#39;s phone number</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :param text: the message text</span>
<span class="sd">        :type text: str</span>
<span class="sd">        :param waitForDeliveryReport: if True, this method blocks until a delivery report is received for the sent message</span>
<span class="sd">        :type waitForDeliveryReport: boolean</span>
<span class="sd">        :param deliveryReport: the maximum time in seconds to wait for a delivery report (if &quot;waitForDeliveryReport&quot; is True)</span>
<span class="sd">        :type deliveryTimeout: int or float </span>
<span class="sd">        </span>
<span class="sd">        :raise CommandError: if an error occurs while attempting to send the message</span>
<span class="sd">        :raise TimeoutException: if the operation times out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGS=&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destination</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expectedResponseTermSeq</span><span class="o">=</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CMGS:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">writeTerm</span><span class="o">=</span><span class="nb">chr</span><span class="p">(</span><span class="mi">26</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdus</span> <span class="o">=</span> <span class="n">encodeSmsSubmitPdu</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_smsRef</span><span class="p">,</span> <span class="n">sendFlash</span><span class="o">=</span><span class="n">sendFlash</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pdu</span> <span class="ow">in</span> <span class="n">pdus</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGS=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pdu</span><span class="o">.</span><span class="n">tpduLength</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expectedResponseTermSeq</span><span class="o">=</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CMGS:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pdu</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">writeTerm</span><span class="o">=</span><span class="nb">chr</span><span class="p">(</span><span class="mi">26</span><span class="p">)))</span> <span class="c1"># example: +CMGS: xx</span>
        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;Modem did not respond with +CMGS response&#39;</span><span class="p">)</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smsRef</span> <span class="o">=</span> <span class="n">reference</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsRef</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsRef</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sms</span> <span class="o">=</span> <span class="n">SentSms</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
        <span class="c1"># Add a weak-referenced entry for this SMS (allows us to update the SMS state if a status report is received)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentSms</span><span class="p">[</span><span class="n">reference</span><span class="p">]</span> <span class="o">=</span> <span class="n">sms</span>
        <span class="k">if</span> <span class="n">waitForDeliveryReport</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">deliveryTimeout</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Response timed out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">TimeoutException</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sms</span></div>

<div class="viewcode-block" id="GsmModem.sendUssd"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.sendUssd">[docs]</a>    <span class="k">def</span> <span class="nf">sendUssd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ussdString</span><span class="p">,</span> <span class="n">responseTimeout</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Starts a USSD session by dialing the the specified USSD string, or \</span>
<span class="sd">        sends the specified string in the existing USSD session (if any)</span>
<span class="sd">                </span>
<span class="sd">        :param ussdString: The USSD access number to dial</span>
<span class="sd">        :param responseTimeout: Maximum time to wait a response, in seconds</span>
<span class="sd">        </span>
<span class="sd">        :raise TimeoutException: if no response is received in time</span>
<span class="sd">        </span>
<span class="sd">        :return: The USSD response message/session (as a Ussd object)</span>
<span class="sd">        :rtype: gsmmodem.modem.Ussd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cusdResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CUSD=1,&quot;</span><span class="si">{0}</span><span class="s1">&quot;,15&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ussdString</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">responseTimeout</span><span class="p">)</span> <span class="c1"># Should respond with &quot;OK&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Cancel the thread sync lock</span>
            <span class="k">raise</span>

        <span class="c1"># Some modems issue the +CUSD response before the acknowledgment &quot;OK&quot; - check for that</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusdResponse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cusdResponseFound</span> <span class="o">=</span> <span class="n">lineStartingWith</span><span class="p">(</span><span class="s1">&#39;+CUSD&#39;</span><span class="p">,</span> <span class="n">cusdResponse</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">cusdResponseFound</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Cancel thread sync lock</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseCusdResponse</span><span class="p">(</span><span class="n">cusdResponse</span><span class="p">)</span>
        <span class="c1"># Wait for the +CUSD notification message</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">responseTimeout</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ussdResponse</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Response timed out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span> <span class="o">=</span> <span class="kc">None</span>            
            <span class="k">raise</span> <span class="n">TimeoutException</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="GsmModem.dial"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.dial">[docs]</a>    <span class="k">def</span> <span class="nf">dial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">callStatusUpdateCallbackFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calls the specified phone number using a voice phone call</span>

<span class="sd">        :param number: The phone number to dial</span>
<span class="sd">        :param timeout: Maximum time to wait for the call to be established</span>
<span class="sd">        :param callStatusUpdateCallbackFunc: Callback function that is executed if the call&#39;s status changes due to</span>
<span class="sd">               remote events (i.e. when it is answered, the call is ended by the remote party)</span>

<span class="sd">        :return: The outgoing call</span>
<span class="sd">        :rtype: gsmmodem.modem.Call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_waitForCallInitUpdate</span><span class="p">:</span>
            <span class="c1"># Wait for the &quot;call originated&quot; notification message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATD</span><span class="si">{0}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">waitForResponse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_waitForAtdResponse</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Cancel the thread sync lock</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Don&#39;t wait for a call init update - base the call ID on the number of active calls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATD</span><span class="si">{0}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">waitForResponse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_waitForAtdResponse</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not waiting for outgoing call init update message&quot;</span><span class="p">)</span>
            <span class="n">callId</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">callType</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Assume voice</span>
            <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">callStatusUpdateCallbackFunc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span>
            <span class="k">return</span> <span class="n">call</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mustPollCallStatus</span><span class="p">:</span>
            <span class="c1"># Fake a call notification by polling call status until the status indicates that the call is being dialed</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pollCallStatus</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;expectedState&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">:</span> <span class="n">timeout</span><span class="p">})</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialResponse</span>
            <span class="n">call</span> <span class="o">=</span> <span class="n">Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">callStatusUpdateCallbackFunc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span>
            <span class="k">return</span> <span class="n">call</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Call establishing timed out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">TimeoutException</span><span class="p">()</span></div>

<div class="viewcode-block" id="GsmModem.processStoredSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.processStoredSms">[docs]</a>    <span class="k">def</span> <span class="nf">processStoredSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unreadOnly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Process all SMS messages currently stored on the device/SIM card.</span>
<span class="sd">        </span>
<span class="sd">        Reads all (or just unread) received SMS messages currently stored on the </span>
<span class="sd">        device/SIM card, initiates &quot;SMS received&quot; events for them, and removes </span>
<span class="sd">        them from the SIM card.</span>
<span class="sd">        This is useful if SMS messages were received during a period that</span>
<span class="sd">        python-gsmmodem was not running but the modem was powered on.</span>
<span class="sd">        </span>
<span class="sd">        :param unreadOnly: If True, only process unread SMS messages</span>
<span class="sd">        :type unreadOnly: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sms</span><span class="o">.</span><span class="n">STATUS_RECEIVED_UNREAD</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unreadOnly</span><span class="p">:</span>
            <span class="n">states</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Sms</span><span class="o">.</span><span class="n">STATUS_RECEIVED_READ</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">msgStatus</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listStoredSms</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">msgStatus</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sms</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsReceivedCallback</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span></div>

<div class="viewcode-block" id="GsmModem.listStoredSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.listStoredSms">[docs]</a>    <span class="k">def</span> <span class="nf">listStoredSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Sms</span><span class="o">.</span><span class="n">STATUS_ALL</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns SMS messages currently stored on the device/SIM card.</span>
<span class="sd">        </span>
<span class="sd">        The messages are read from the memory set by the &quot;memory&quot; parameter.</span>
<span class="sd">        </span>
<span class="sd">        :param status: Filter messages based on this read status; must be 0-4 (see Sms class)</span>
<span class="sd">        :type status: int</span>
<span class="sd">        :param memory: The memory type to read from. If None, use the current default SMS read memory</span>
<span class="sd">        :type memory: str or None</span>
<span class="sd">        :param delete: If True, delete returned messages from the device/SIM card</span>
<span class="sd">        :type delete: bool</span>
<span class="sd">        </span>
<span class="sd">        :return: A list of Sms objects containing the messages read</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setSmsMemory</span><span class="p">(</span><span class="n">readDelete</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delMessages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span><span class="p">:</span>
            <span class="n">cmglRegex</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CMGL: (\d+),&quot;([^&quot;]+)&quot;,&quot;([^&quot;]+)&quot;,[^,]*,&quot;([^&quot;]+)&quot;$&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dictItemsIter</span><span class="p">(</span><span class="n">Sms</span><span class="o">.</span><span class="n">TEXT_MODE_STATUS_MAP</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">statusStr</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid status value: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGL=&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statusStr</span><span class="p">))</span>
            <span class="n">msgLines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">msgIndex</span> <span class="o">=</span> <span class="n">msgStatus</span> <span class="o">=</span> <span class="n">number</span> <span class="o">=</span> <span class="n">msgTime</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">cmglMatch</span> <span class="o">=</span> <span class="n">cmglRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                
                <span class="k">if</span> <span class="n">cmglMatch</span><span class="p">:</span>
                    <span class="c1"># New message; save old one if applicable</span>
                    <span class="k">if</span> <span class="n">msgIndex</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgLines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">msgText</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgLines</span><span class="p">)</span>
                        <span class="n">msgLines</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReceivedSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sms</span><span class="o">.</span><span class="n">TEXT_MODE_STATUS_MAP</span><span class="p">[</span><span class="n">msgStatus</span><span class="p">],</span> <span class="n">number</span><span class="p">,</span> <span class="n">parseTextModeTimeStr</span><span class="p">(</span><span class="n">msgTime</span><span class="p">),</span> <span class="n">msgText</span><span class="p">))</span>
                        <span class="n">delMessages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">))</span>
                    <span class="n">msgIndex</span><span class="p">,</span> <span class="n">msgStatus</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">msgTime</span> <span class="o">=</span> <span class="n">cmglMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="n">msgLines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
                        <span class="n">msgLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msgIndex</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgLines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msgText</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgLines</span><span class="p">)</span>
                <span class="n">msgLines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReceivedSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sms</span><span class="o">.</span><span class="n">TEXT_MODE_STATUS_MAP</span><span class="p">[</span><span class="n">msgStatus</span><span class="p">],</span> <span class="n">number</span><span class="p">,</span> <span class="n">parseTextModeTimeStr</span><span class="p">(</span><span class="n">msgTime</span><span class="p">),</span> <span class="n">msgText</span><span class="p">))</span>
                <span class="n">delMessages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmglRegex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\+CMGL:\s*(\d+),\s*(\d+),.*$&#39;</span><span class="p">)</span>
            <span class="n">readPdu</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGL=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">readPdu</span><span class="p">:</span>
                    <span class="n">cmglMatch</span> <span class="o">=</span> <span class="n">cmglRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cmglMatch</span><span class="p">:</span>
                        <span class="n">msgIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmglMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">msgStat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmglMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">readPdu</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">smsDict</span> <span class="o">=</span> <span class="n">decodeSmsPdu</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">EncodingError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Discarding line from +CMGL response: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SMS-DELIVER&#39;</span><span class="p">:</span>
                            <span class="n">sms</span> <span class="o">=</span> <span class="n">ReceivedSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">msgStat</span><span class="p">),</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;smsc&#39;</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SMS-STATUS-REPORT&#39;</span><span class="p">:</span>
                            <span class="n">sms</span> <span class="o">=</span> <span class="n">StatusReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">msgStat</span><span class="p">),</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;discharge&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;Invalid PDU type for readStoredSms(): </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span>
                        <span class="n">delMessages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">)</span>
                        <span class="n">readPdu</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Sms</span><span class="o">.</span><span class="n">STATUS_ALL</span><span class="p">:</span>
                <span class="c1"># Delete all messages</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deleteMultipleStoredSms</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">msgIndex</span> <span class="ow">in</span> <span class="n">delMessages</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deleteStoredSms</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">messages</span></div>

    <span class="k">def</span> <span class="nf">_handleModemNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for unsolicited notifications from the modem</span>
<span class="sd">        </span>
<span class="sd">        This method simply spawns a separate thread to handle the actual notification</span>
<span class="sd">        (in order to release the read thread so that the handlers are able to write back to the modem, etc)</span>
<span class="sd">         </span>
<span class="sd">        :param lines The lines that were read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__threadedHandleModemNotification</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="n">lines</span><span class="p">})</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__threadedHandleModemNotification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implementation of _handleModemNotification() to be run in a separate thread</span>
<span class="sd">        </span>
<span class="sd">        :param lines The lines that were read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;RING&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># Incoming call (or existing call is ringing)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handleIncomingCall</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CMTI&#39;</span><span class="p">):</span>
                <span class="c1"># New SMS message indication</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handleSmsReceived</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CUSD&#39;</span><span class="p">):</span>
                <span class="c1"># USSD notification - either a response or a MT-USSD (&quot;push USSD&quot;) message</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handleUssd</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+CDSI&#39;</span><span class="p">):</span>
                <span class="c1"># SMS status report</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handleSmsStatusReport</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check for call status updates            </span>
                <span class="k">for</span> <span class="n">updateRegex</span><span class="p">,</span> <span class="n">handlerFunc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdates</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">updateRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="c1"># Handle the update</span>
                        <span class="n">handlerFunc</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
                        <span class="k">return</span>
        <span class="c1"># If this is reached, the notification wasn&#39;t handled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Unhandled unsolicited modem notification: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>    
    
    <span class="k">def</span> <span class="nf">_handleIncomingCall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Handling incoming call&#39;</span><span class="p">)</span>
        <span class="n">ringLine</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extendedIncomingCallIndication</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">callType</span> <span class="o">=</span> <span class="n">ringLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># Some external 3G scripts modify incoming call indication settings (issue #18)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Extended incoming call indication format changed externally; re-enabling...&#39;</span><span class="p">)</span>
                <span class="n">callType</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Re-enable extended format of incoming indication (optional)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CRC=1&#39;</span><span class="p">)</span> 
                <span class="k">except</span> <span class="n">CommandError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Extended incoming call indication format changed externally; unable to re-enable&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_extendedIncomingCallIndication</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callingLineIdentification</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">clipLine</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">clipMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CLIP_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">clipLine</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clipMatch</span><span class="p">:</span>
                <span class="n">callerNumber</span> <span class="o">=</span> <span class="n">clipMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ton</span> <span class="o">=</span> <span class="n">clipMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#TODO: re-add support for this</span>
                <span class="n">callerName</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1">#callerName = clipMatch.group(3)</span>
                <span class="c1">#if callerName != None and len(callerName) == 0:</span>
                <span class="c1">#    callerName = None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">callerNumber</span> <span class="o">=</span> <span class="n">ton</span> <span class="o">=</span> <span class="n">callerName</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callerNumber</span> <span class="o">=</span> <span class="n">ton</span> <span class="o">=</span> <span class="n">callerName</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">call</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">activeCall</span> <span class="ow">in</span> <span class="n">dictValuesIter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">activeCall</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="n">callerNumber</span><span class="p">:</span>
                <span class="n">call</span> <span class="o">=</span> <span class="n">activeCall</span>
                <span class="n">call</span><span class="o">.</span><span class="n">ringCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">call</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">callId</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">call</span> <span class="o">=</span> <span class="n">IncomingCall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callerNumber</span><span class="p">,</span> <span class="n">ton</span><span class="p">,</span> <span class="n">callerName</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span> <span class="o">=</span> <span class="n">call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incomingCallCallback</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>    
    
    <span class="k">def</span> <span class="nf">_handleCallInitiated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regexMatch</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callType</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for &quot;outgoing call initiated&quot; event notification line &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">regexMatch</span><span class="p">:</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">regexMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="c1"># Set self._dialReponse to (callId, callType)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dialResponse</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dialResponse</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># assume call type: VOICE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dialResponse</span> <span class="o">=</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dialEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">_handleCallAnswered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regexMatch</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for &quot;outgoing call answered&quot; event notification line &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">regexMatch</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">regexMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">callId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span><span class="o">.</span><span class="n">answered</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Call ID not available for this notificition - check for the first outgoing call that has not been answered</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">dictValuesIter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">answered</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="o">==</span> <span class="n">Call</span><span class="p">:</span>
                        <span class="n">call</span><span class="o">.</span><span class="n">answered</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use supplied values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span><span class="o">.</span><span class="n">answered</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_handleCallEnded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regexMatch</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filterUnanswered</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">regexMatch</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">regexMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">callId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Call ID not available for this notification - check for the first outgoing call that is active</span>
                <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">dictValuesIter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">call</span><span class="p">)</span> <span class="o">==</span> <span class="n">Call</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">filterUnanswered</span> <span class="ow">or</span> <span class="p">(</span><span class="n">filterUnanswered</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">call</span><span class="o">.</span><span class="n">answered</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="n">callId</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">id</span>
                            <span class="k">break</span>
        <span class="k">if</span> <span class="n">callId</span> <span class="ow">and</span> <span class="n">callId</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span><span class="o">.</span><span class="n">answered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="n">callId</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_handleCallRejected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regexMatch</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for rejected (unanswered calls being ended)</span>

<span class="sd">        Most modems use _handleCallEnded for handling both call rejections and remote hangups.</span>
<span class="sd">        This method does the same, but filters for unanswered calls only.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallEnded</span><span class="p">(</span><span class="n">regexMatch</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handleSmsReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notificationLine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for &quot;new SMS&quot; unsolicited notification line &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;SMS message received&#39;</span><span class="p">)</span>
        <span class="n">cmtiMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMTI_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">notificationLine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmtiMatch</span><span class="p">:</span>
            <span class="n">msgMemory</span> <span class="o">=</span> <span class="n">cmtiMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">msgIndex</span> <span class="o">=</span> <span class="n">cmtiMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readStoredSms</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">,</span> <span class="n">msgMemory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleteStoredSms</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsReceivedCallback</span><span class="p">(</span><span class="n">sms</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_handleSmsStatusReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notificationLine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for SMS status reports &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;SMS status report received&#39;</span><span class="p">)</span>
        <span class="n">cdsiMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CDSI_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">notificationLine</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdsiMatch</span><span class="p">:</span>
            <span class="n">msgMemory</span> <span class="o">=</span> <span class="n">cdsiMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">msgIndex</span> <span class="o">=</span> <span class="n">cdsiMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readStoredSms</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">,</span> <span class="n">msgMemory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleteStoredSms</span><span class="p">(</span><span class="n">msgIndex</span><span class="p">)</span>
            <span class="c1"># Update sent SMS status if possible            </span>
            <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">reference</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentSms</span><span class="p">:</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">sentSms</span><span class="p">[</span><span class="n">report</span><span class="o">.</span><span class="n">reference</span><span class="p">]</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">report</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span><span class="p">:</span>                
                <span class="c1"># A sendSms() call is waiting for this response - notify waiting thread</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smsStatusReportEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Nothing is waiting for this report directly - use callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsStatusReportCallback</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    
<div class="viewcode-block" id="GsmModem.readStoredSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.readStoredSms">[docs]</a>    <span class="k">def</span> <span class="nf">readStoredSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reads and returns the SMS message at the specified index</span>
<span class="sd">        </span>
<span class="sd">        :param index: The index of the SMS message in the specified memory</span>
<span class="sd">        :type index: int</span>
<span class="sd">        :param memory: The memory type to read from. If None, use the current default SMS read memory</span>
<span class="sd">        :type memory: str or None</span>
<span class="sd">        </span>
<span class="sd">        :raise CommandError: if unable to read the stored message</span>
<span class="sd">        </span>
<span class="sd">        :return: The SMS message</span>
<span class="sd">        :rtype: subclass of gsmmodem.modem.Sms (either ReceivedSms or StatusReport)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Switch to the correct memory type if required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setSmsMemory</span><span class="p">(</span><span class="n">readDelete</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
        <span class="n">msgData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGR=</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="c1"># Parse meta information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smsTextMode</span><span class="p">:</span>
            <span class="n">cmgrMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_SM_DELIVER_REGEX_TEXT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">msgData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cmgrMatch</span><span class="p">:</span>
                <span class="n">msgStatus</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">msgTime</span> <span class="o">=</span> <span class="n">cmgrMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="n">msgText</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgData</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">ReceivedSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sms</span><span class="o">.</span><span class="n">TEXT_MODE_STATUS_MAP</span><span class="p">[</span><span class="n">msgStatus</span><span class="p">],</span> <span class="n">number</span><span class="p">,</span> <span class="n">parseTextModeTimeStr</span><span class="p">(</span><span class="n">msgTime</span><span class="p">),</span> <span class="n">msgText</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try parsing status report</span>
                <span class="n">cmgrMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_SM_REPORT_REGEXT_TEXT</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">msgData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cmgrMatch</span><span class="p">:</span>
                    <span class="n">msgStatus</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">sentTime</span><span class="p">,</span> <span class="n">deliverTime</span><span class="p">,</span> <span class="n">deliverStatus</span> <span class="o">=</span> <span class="n">cmgrMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">msgStatus</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
                        <span class="n">msgStatus</span> <span class="o">=</span> <span class="n">msgStatus</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                    
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgStatus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">msgStatus</span> <span class="o">=</span> <span class="s2">&quot;REC UNREAD&quot;</span>
                    <span class="k">return</span> <span class="n">StatusReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Sms</span><span class="o">.</span><span class="n">TEXT_MODE_STATUS_MAP</span><span class="p">[</span><span class="n">msgStatus</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">reference</span><span class="p">),</span> <span class="n">number</span><span class="p">,</span> <span class="n">parseTextModeTimeStr</span><span class="p">(</span><span class="n">sentTime</span><span class="p">),</span> <span class="n">parseTextModeTimeStr</span><span class="p">(</span><span class="n">deliverTime</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">deliverStatus</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;Failed to parse text-mode SMS message +CMGR response: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msgData</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmgrMatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CMGR_REGEX_PDU</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">msgData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cmgrMatch</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;Failed to parse PDU-mode SMS message +CMGR response: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msgData</span><span class="p">))</span>
            <span class="n">stat</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">cmgrMatch</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Some modems (ZTE) do not always read return status - default to RECEIVED UNREAD</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">Sms</span><span class="o">.</span><span class="n">STATUS_RECEIVED_UNREAD</span>
            <span class="n">pdu</span> <span class="o">=</span> <span class="n">msgData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">smsDict</span> <span class="o">=</span> <span class="n">decodeSmsPdu</span><span class="p">(</span><span class="n">pdu</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SMS-DELIVER&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ReceivedSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;smsc&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SMS-STATUS-REPORT&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">StatusReport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;discharge&#39;</span><span class="p">],</span> <span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span><span class="s1">&#39;Invalid PDU type for readStoredSms(): </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smsDict</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span></div>
    
<div class="viewcode-block" id="GsmModem.deleteStoredSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.deleteStoredSms">[docs]</a>    <span class="k">def</span> <span class="nf">deleteStoredSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deletes the SMS message stored at the specified index in modem/SIM card memory</span>
<span class="sd">        </span>
<span class="sd">        :param index: The index of the SMS message in the specified memory</span>
<span class="sd">        :type index: int</span>
<span class="sd">        :param memory: The memory type to delete from. If None, use the current default SMS read/delete memory</span>
<span class="sd">        :type memory: str or None</span>
<span class="sd">        </span>
<span class="sd">        :raise CommandError: if unable to delete the stored message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setSmsMemory</span><span class="p">(</span><span class="n">readDelete</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGD=</span><span class="si">{0}</span><span class="s1">,0&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="GsmModem.deleteMultipleStoredSms"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.GsmModem.deleteMultipleStoredSms">[docs]</a>    <span class="k">def</span> <span class="nf">deleteMultipleStoredSms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delFlag</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deletes all SMS messages that have the specified read status.</span>
<span class="sd">        </span>
<span class="sd">        The messages are read from the memory set by the &quot;memory&quot; parameter.</span>
<span class="sd">        The value of the &quot;delFlag&quot; paramater is the same as the &quot;DelFlag&quot; parameter of the +CMGD command:</span>
<span class="sd">        1: Delete All READ messages</span>
<span class="sd">        2: Delete All READ and SENT messages</span>
<span class="sd">        3: Delete All READ, SENT and UNSENT messages</span>
<span class="sd">        4: Delete All messages (this is the default)</span>
<span class="sd"> </span>
<span class="sd">        :param delFlag: Controls what type of messages to delete; see description above.</span>
<span class="sd">        :type delFlag: int</span>
<span class="sd">        :param memory: The memory type to delete from. If None, use the current default SMS read/delete memory</span>
<span class="sd">        :type memory: str or None</span>
<span class="sd">        :param delete: If True, delete returned messages from the device/SIM card</span>
<span class="sd">        :type delete: bool</span>
<span class="sd">        </span>
<span class="sd">        :raise ValueErrror: if &quot;delFlag&quot; is not in range [1,4]</span>
<span class="sd">        :raise CommandError: if unable to delete the stored messages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">delFlag</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setSmsMemory</span><span class="p">(</span><span class="n">readDelete</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CMGD=1,</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">delFlag</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;&quot;delFlag&quot; must be in range [1,4]&#39;</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">_handleUssd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handler for USSD event notification line(s) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span><span class="p">:</span>
            <span class="c1"># A sendUssd() call is waiting for this response - parse it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ussdResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parseCusdResponse</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="c1"># Notify waiting thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ussdSessionEvent</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_parseCusdResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Parses one or more +CUSD notification lines (for USSD)</span>
<span class="sd">        :return: USSD response object</span>
<span class="sd">        :rtype: gsmmodem.modem.Ussd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Issue #20: Some modem/network combinations use \r\n as in-message EOL indicators;</span>
            <span class="c1"># - join lines to compensate for that (thanks to davidjb for the fix)</span>
            <span class="c1"># Also, look for more than one +CUSD response because of certain modems&#39; strange behaviour</span>
            <span class="n">cusdMatches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CUSD_REGEX</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single standard +CUSD response</span>
            <span class="n">cusdMatches</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CUSD_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sessionActive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusdMatches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Multiple +CUSD responses received; filtering...&#39;</span><span class="p">)</span>
            <span class="c1"># Some modems issue a non-standard &quot;extra&quot; +CUSD notification for releasing the session</span>
            <span class="k">for</span> <span class="n">cusdMatch</span> <span class="ow">in</span> <span class="n">cusdMatches</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cusdMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
                    <span class="c1"># Set the session to inactive, but ignore the message</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignoring &quot;session release&quot; message: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cusdMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">sessionActive</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Not a &quot;session release&quot; message</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">cusdMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sessionActive</span> <span class="ow">and</span> <span class="n">cusdMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                        <span class="n">sessionActive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sessionActive</span> <span class="o">=</span> <span class="n">cusdMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">cusdMatches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ussd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessionActive</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_placeHolderCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Does nothing &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;called with args: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_pollCallStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expectedState</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Poll the status of outgoing calls.    </span>
<span class="sd">        This is used for modems that do not have a known set of call status update notifications.</span>
<span class="sd">        </span>
<span class="sd">        :param expectedState: The internal state we are waiting for. 0 == initiated, 1 == answered, 2 = hangup</span>
<span class="sd">        :type expectedState: int</span>
<span class="sd">        </span>
<span class="sd">        :raise TimeoutException: If a timeout was specified, and has occurred</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callDone</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">timeLeft</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="mi">999999</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">alive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callDone</span> <span class="ow">and</span> <span class="n">timeLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expectedState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Only call initializing can timeout</span>
                <span class="n">timeLeft</span> <span class="o">-=</span> <span class="mf">0.5</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">clcc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pollCallStatusRegex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CLCC&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="c1"># Can happend if the call was ended during our time.sleep() call</span>
                <span class="n">clcc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">clcc</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clcc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Outgoing call</span>
                    <span class="c1"># Determine call state</span>
                    <span class="n">stat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clcc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">expectedState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># waiting for call initiated</span>
                        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">stat</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Dialing or ringing (&quot;alerting&quot;)                            </span>
                            <span class="n">callId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clcc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">callType</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clcc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallInitiated</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">)</span> <span class="c1"># if self_dialEvent is None, this does nothing</span>
                            <span class="n">expectedState</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Now wait for call answer</span>
                    <span class="k">elif</span> <span class="n">expectedState</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># waiting for call to be answered</span>
                        <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Call active</span>
                            <span class="n">callId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clcc</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallAnswered</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">callId</span><span class="p">)</span>
                            <span class="n">expectedState</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Now wait for call hangup                            </span>
            <span class="k">elif</span> <span class="n">expectedState</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span> <span class="c1"># waiting for remote hangup</span>
                <span class="c1"># Since there was no +CLCC response, the call is no longer active</span>
                <span class="n">callDone</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallEnded</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="n">callId</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">expectedState</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># waiting for call to be answered</span>
                <span class="c1"># Call was rejected</span>
                <span class="n">callDone</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handleCallRejected</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">callId</span><span class="o">=</span><span class="n">callId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeLeft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TimeoutException</span><span class="p">()</span></div>


<div class="viewcode-block" id="Call"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Call">[docs]</a><span class="k">class</span> <span class="nc">Call</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A voice call &quot;&quot;&quot;</span>
    
    <span class="n">DTMF_COMMAND_BASE</span> <span class="o">=</span> <span class="s1">&#39;+VTS=&#39;</span>
    <span class="n">dtmfSupport</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Indicates whether or not DTMF tones can be sent in calls</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsmModem</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">callStatusUpdateCallbackFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param gsmModem: GsmModem instance that created this object</span>
<span class="sd">        :param number: The number that is being called        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">gsmModem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdateCallbackFunc</span> <span class="o">=</span> <span class="n">callStatusUpdateCallbackFunc</span>
        <span class="c1"># Unique ID of this call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">callId</span>
        <span class="c1"># Call type (VOICE == 0, etc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">callType</span>        
        <span class="c1"># The remote number of this call (destination or origin)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">number</span>                
        <span class="c1"># Flag indicating whether the call has been answered or not (backing field for &quot;answered&quot; property)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_answered</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Flag indicating whether or not the call is active</span>
        <span class="c1"># (meaning it may be ringing or answered, but not ended because of a hangup event)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">answered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_answered</span>
    <span class="nd">@answered</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">answered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answered</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_answered</span> <span class="o">=</span> <span class="n">answered</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdateCallbackFunc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_callStatusUpdateCallbackFunc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
<div class="viewcode-block" id="Call.sendDtmfTone"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Call.sendDtmfTone">[docs]</a>    <span class="k">def</span> <span class="nf">sendDtmfTone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tones</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send one or more DTMF tones to the remote party (only allowed for an answered call) </span>
<span class="sd">        </span>
<span class="sd">        Note: this is highly device-dependent, and might not work</span>
<span class="sd">        </span>
<span class="sd">        :param digits: A str containining one or more DTMF tones to play, e.g. &quot;3&quot; or &quot;\*123#&quot;</span>

<span class="sd">        :raise CommandError: if the command failed/is not supported        </span>
<span class="sd">        :raise InvalidStateException: if the call has not been answered, or is ended while the command is still executing</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answered</span><span class="p">:</span>
            <span class="n">dtmfCommandBase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DTMF_COMMAND_BASE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">toneLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tones</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tones</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;AT</span><span class="si">{0}{1}</span><span class="s1">;</span><span class="si">{0}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tones</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtmfCommandBase</span><span class="p">,</span> <span class="n">tones</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;AT</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtmfCommandBase</span><span class="p">,</span> <span class="n">tones</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">toneLen</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">CmeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="c1"># No network service - can happen if call is ended during DTMF transmission (but also if DTMF is sent immediately after call is answered)</span>
                    <span class="k">raise</span> <span class="n">InterruptedException</span><span class="p">(</span><span class="s1">&#39;No network service&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># Operation not allowed - can happen if call is ended during DTMF transmission</span>
                    <span class="k">raise</span> <span class="n">InterruptedException</span><span class="p">(</span><span class="s1">&#39;Operation not allowed&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span><span class="s1">&#39;Call is not active (it has not yet been answered, or it has ended).&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Call.hangup"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Call.hangup">[docs]</a>    <span class="k">def</span> <span class="nf">hangup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; End the phone call.</span>
<span class="sd">        </span>
<span class="sd">        Does nothing if the call is already inactive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATH&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">activeCalls</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span></div></div>


<span class="k">class</span> <span class="nc">IncomingCall</span><span class="p">(</span><span class="n">Call</span><span class="p">):</span>
    
    <span class="n">CALL_TYPE_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;VOICE&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    
    <span class="sd">&quot;&quot;&quot; Represents an incoming call, conveniently allowing access to call meta information and -control &quot;&quot;&quot;</span>     
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsmModem</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">ton</span><span class="p">,</span> <span class="n">callerName</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param gsmModem: GsmModem instance that created this object</span>
<span class="sd">        :param number: Caller number</span>
<span class="sd">        :param ton: TON (type of number/address) in integer format</span>
<span class="sd">        :param callType: Type of the incoming call (VOICE, FAX, DATA, etc)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">callType</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">callType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CALL_TYPE_MAP</span><span class="p">[</span><span class="n">callType</span><span class="p">]</span> 
        <span class="nb">super</span><span class="p">(</span><span class="n">IncomingCall</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">gsmModem</span><span class="p">,</span> <span class="n">callId</span><span class="p">,</span> <span class="n">callType</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>        
        <span class="c1"># Type attribute of the incoming call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ton</span> <span class="o">=</span> <span class="n">ton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callerName</span> <span class="o">=</span> <span class="n">callerName</span>        
        <span class="c1"># Flag indicating whether the call is ringing or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ringing</span> <span class="o">=</span> <span class="kc">True</span>        
        <span class="c1"># Amount of times this call has rung (before answer/hangup)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ringCount</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">answer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Answer the phone call.        </span>
<span class="sd">        :return: self (for chaining method calls)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ringing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ATA&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ringing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answered</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>    

    <span class="k">def</span> <span class="nf">hangup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; End the phone call. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ringing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IncomingCall</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">hangup</span><span class="p">()</span>

<div class="viewcode-block" id="Ussd"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Ussd">[docs]</a><span class="k">class</span> <span class="nc">Ussd</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Unstructured Supplementary Service Data (USSD) message.</span>
<span class="sd">    </span>
<span class="sd">    This class contains convenient methods for replying to a USSD prompt</span>
<span class="sd">    and to cancel the USSD session</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsmModem</span><span class="p">,</span> <span class="n">sessionActive</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">gsmModem</span><span class="p">)</span>
        <span class="c1"># Indicates if the session is active (True) or has been closed (False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionActive</span> <span class="o">=</span> <span class="n">sessionActive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
    
<div class="viewcode-block" id="Ussd.reply"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Ussd.reply">[docs]</a>    <span class="k">def</span> <span class="nf">reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sends a reply to this USSD message in the same USSD session </span>
<span class="sd">        </span>
<span class="sd">        :raise InvalidStateException: if the USSD session is not active (i.e. it has ended)</span>
<span class="sd">        </span>
<span class="sd">        :return: The USSD response message/session (as a Ussd object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionActive</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">sendUssd</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidStateException</span><span class="p">(</span><span class="s1">&#39;USSD session is inactive&#39;</span><span class="p">)</span></div>
                
<div class="viewcode-block" id="Ussd.cancel"><a class="viewcode-back" href="../../api.html#gsmmodem.modem.Ussd.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Terminates/cancels the USSD session (without sending a reply)</span>
<span class="sd">        </span>
<span class="sd">        Does nothing if the USSD session is inactive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessionActive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gsmModem</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;AT+CUSD=2&#39;</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">python-gsmmodem 0.9 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013, Developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>