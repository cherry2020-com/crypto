server {
 server_name vfile.grtn.cn;
 listen *:80;
 resolver 127.0.0.1;
 set $cc_host $http_cc_host;
 set $cache_key '$http_host$request_uri';
 set $cache_allow 1;
 set $cc_cacheable 1;
 set $cache_stored -;
 set $ignore_reload 0;
 set $expire_body 0;
 set $cache_http_code "200 203 300 301 302 410";
 set $storage_api_port 770;
 set $use_stale 0;
 set $collapsed_forwarding 1;
 set $redirect_location 0;
 allow_range on;
 set $cc_upstream_addr -;
 set $default_valid_second 86400;
 location ~ /cc_proxy_pass(.*) {
  access_log off;
  more_set_headers "CC-UP: $upstream_addr";
  proxy_set_header Host $cc_host;
  set $cc_uri $1;
  set $cc_port 80;
  if ($http_cc_port ~ "^[1-9]\d{0,4}$") {
   more_clear_input_headers CC-PORT;
   set $cc_port $http_cc_port;
}
  set $cc_proxy_url "http://$cc_host:$cc_port$cc_uri$is_args$args";
  if ($http_cc_simplify_question = 1) {
   more_clear_input_headers CC-Simplify-Question;
   set $cc_proxy_url "http://$cc_host:$cc_port$cc_uri";
}
  proxy_pass $cc_proxy_url;
}
 location / {
  if ($http_user_agent = ChinaCache-NOC) {
   set $cache_allow 0;
   set $cc_cacheable 0;
}
  set $cache_status "TCP_MISS";
  add_header CC_CACHE $cache_status;
  content_by_lua_file 'conf/lua/hpc_proxy.lua';
  access_by_lua_file 'conf/lua/access_phase/access_phase_hook.lua';
  log_by_lua_file 'conf/lua/log_phase/log_phase_hook.lua';
  set $cc_cacheable 1;
  set $default_valid_second 2592000;
}
 location ~* /do_not_delete/noc.gif {
  set $cache_allow 0;
  set $cc_cacheable 0;
  if ($http_user_agent = ChinaCache-NOC) {
   set $cache_allow 0;
   set $cc_cacheable 0;
}
  set $cache_status "TCP_MISS";
  add_header CC_CACHE $cache_status;
  content_by_lua_file 'conf/lua/hpc_proxy.lua';
  access_by_lua_file 'conf/lua/access_phase/access_phase_hook.lua';
  log_by_lua_file 'conf/lua/log_phase/log_phase_hook.lua';
}
 location ~* /2016/1451/8101/do_not_delete/noc.gif {
  if ($http_user_agent = ChinaCache-NOC) {
   set $cache_allow 0;
   set $cc_cacheable 0;
}
  set $cache_status "TCP_MISS";
  add_header CC_CACHE $cache_status;
  content_by_lua_file 'conf/lua/hpc_proxy.lua';
  access_by_lua_file 'conf/lua/access_phase/access_phase_hook.lua';
  log_by_lua_file 'conf/lua/log_phase/log_phase_hook.lua';
  set $cache_allow 0;
  set $cc_cacheable 0;
}
}